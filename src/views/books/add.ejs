<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@11.1.0/public/assets/styles/choices.min.css" />
<script src="https://cdn.jsdelivr.net/npm/choices.js@11.1.0/public/assets/scripts/choices.min.js"></script>
<script src="/js/debounce.js"></script>
<script src="/js/useChoice.js"></script>

<div class="max-w-4xl mx-auto p-6 bg-white rounded-2xl shadow-md mt-6">
  <h1 class="text-3xl font-bold mb-6 text-gray-700 flex items-center gap-2">
    📚 Thêm sách mới
  </h1>

  <%- include('../error') %>

    <form enctype="multipart/form-data" method="POST" class="space-y-5">
      <!-- Tên sách -->
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Tên sách</label>
        <input type="text" id="title" name="title" placeholder="Nhập tên sách..."
          class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          required />
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- ISBN -->
        <div>
          <label for="isbn" class="block text-sm font-medium text-gray-700 mb-1">ISBN</label>
          <input type="text" id="isbn" name="isbn" placeholder="Nhập mã ISBN..."
            class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            required />
        </div>

        <!-- Năm xuất bản -->
        <div>
          <label for="published_year" class="block text-sm font-medium text-gray-700 mb-1">Năm xuất bản</label>
          <input type="number" id="published_year" name="published_year" placeholder="VD: 2024"
            class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            required />
        </div>
      </div>

      <!-- Tác giả -->
      <div>
        <label for="authors" class="block text-sm font-medium text-gray-700 mb-1">Tác giả</label>
        <select name="authors" id="authors" class="block w-full border border-gray-300 rounded-lg shadow-sm p-2"
          multiple required></select>
      </div>

      <!-- Thể loại -->
      <div>
        <label for="genres" class="block text-sm font-medium text-gray-700 mb-1">Thể loại</label>
        <select name="genres" id="genres" class="block w-full border border-gray-300 rounded-lg shadow-sm p-2" multiple
          required></select>
      </div>

      <!-- Số lượng -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="quantity_total" class="block text-sm font-medium text-gray-700 mb-1">Tổng số lượng</label>
          <input type="number" id="quantity_total" name="quantity_total" placeholder="VD: 20"
            class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            required />
        </div>

        <div>
          <label for="quantity_available" class="block text-sm font-medium text-gray-700 mb-1">Số lượng còn lại</label>
          <input type="number" id="quantity_available" name="quantity_available" placeholder="VD: 15"
            class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            required />
        </div>
      </div>

      <!-- Mô tả -->
      <div>
        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Mô tả</label>
        <textarea id="description" name="description" rows="4" placeholder="Nhập mô tả ngắn gọn về sách..."
          class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
      </div>

      <!-- Ảnh bìa -->
      <div>
        <label for="image_cover" class="block text-sm font-medium text-gray-700 mb-1">Ảnh bìa</label>
        <input type="file" id="image_cover" name="image_cover" accept="image/*"
          class="block w-full border border-gray-300 rounded-lg shadow-sm p-2 file:mr-3 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-600 file:text-white hover:file:bg-blue-700"
          required />
        <div id="show_image_cover" class="mt-3"></div>
      </div>

      <!-- Nút -->
      <div class="flex flex-wrap justify-between items-center gap-3 mt-6">
        <a href="/dashboard/books" class="text-gray-600 hover:text-blue-600 hover:underline transition"> Quay lại danh sách</a>
        <button type="submit"
          class="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium shadow transition">
          💾 Lưu sách
        </button>
      </div>
    </form>
</div>

<script>
  // Hiển thị ảnh xem trước
  const image_cover = document.getElementById("image_cover");
  const show_image_cover = document.getElementById("show_image_cover");
  image_cover.addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (event) {
        show_image_cover.innerHTML = `
          <img src="${event.target.result}" alt="Ảnh bìa"
            class="mt-2 max-h-56 rounded-lg shadow-md border border-gray-200 object-contain">
        `;
      };
      reader.readAsDataURL(file);
    } else {
      show_image_cover.innerHTML = "";
    }
  });

  // Khởi tạo Choices.js với dữ liệu động
  useChoice("#authors", "/authors/search", (data) => {
    return data.data.map((author) => ({
      value: author.id,
      label: author.name,
    }));
  });
  useChoice("#genres", "/genre/search", (data) => {
    return data.data.map((genre) => ({
      value: genre.id,
      label: genre.name,
    }));
  });
</script>